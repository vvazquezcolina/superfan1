<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Email Verification - WiFi Portal">
    <meta name="robots" content="noindex, nofollow">
    <title>Email Verification - WiFi Portal</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
    
    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p class="loading-text">Verifying your email...</p>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header Section -->
        <header class="header">
            <div class="logo-container">
                <img src="assets/images/logo-placeholder.svg" alt="Company Logo" class="logo">
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Verification Status Section -->
            <section class="verification-section">
                <!-- Success State -->
                <div id="verification-success" class="verification-result hidden">
                    <div class="result-icon success-icon">✓</div>
                    <h1 class="result-title">Email Verified Successfully!</h1>
                    <p class="result-message">
                        Your email address has been verified. You now have access to our WiFi network.
                    </p>
                    <div class="result-actions">
                        <button id="connect-now-btn" class="submit-btn">
                            <span class="btn-text">Connect to WiFi</span>
                        </button>
                        <p class="connection-info">
                            You will be automatically connected to the internet in <span id="countdown">5</span> seconds.
                        </p>
                    </div>
                </div>

                <!-- Error State -->
                <div id="verification-error" class="verification-result hidden">
                    <div class="result-icon error-icon">⚠</div>
                    <h1 class="result-title">Verification Failed</h1>
                    <p class="result-message" id="error-details">
                        The verification link is invalid or has expired. Please try registering again.
                    </p>
                    <div class="result-actions">
                        <a href="index.html" class="submit-btn">
                            <span class="btn-text">Register Again</span>
                        </a>
                        <button id="resend-btn" class="submit-btn btn-secondary">
                            <span class="btn-text">Resend Verification Email</span>
                            <span class="btn-spinner hidden">
                                <div class="spinner-small"></div>
                            </span>
                        </button>
                    </div>
                </div>

                <!-- Processing State -->
                <div id="verification-processing" class="verification-result">
                    <div class="result-icon processing-icon">
                        <div class="spinner"></div>
                    </div>
                    <h1 class="result-title">Verifying Your Email</h1>
                    <p class="result-message">
                        Please wait while we verify your email address...
                    </p>
                </div>
            </section>

            <!-- Help Section -->
            <section class="help-section">
                <details class="help-details">
                    <summary class="help-summary">Having trouble?</summary>
                    <div class="help-content">
                        <p><strong>If verification failed:</strong></p>
                        <ul class="help-list">
                            <li>Check if you clicked the correct link in your email</li>
                            <li>Make sure the verification link hasn't expired (links are valid for 1 hour)</li>
                            <li>Try requesting a new verification email</li>
                            <li>Check your spam/junk folder for the email</li>
                            <li>Make sure you're using the same device and browser</li>
                        </ul>
                        <p class="help-contact">
                            <strong>Still need help?</strong> 
                            <a href="mailto:support@your-domain.com" class="help-link">Contact Support</a>
                        </p>
                    </div>
                </details>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <p class="footer-text">
                    &copy; 2024 Your Company Name. All rights reserved.
                </p>
                <div class="footer-links">
                    <a href="index.html" class="footer-link">Back to Portal</a>
                    <span class="footer-separator">|</span>
                    <a href="#" class="footer-link">Terms</a>
                    <span class="footer-separator">|</span>
                    <a href="#" class="footer-link">Privacy</a>
                    <span class="footer-separator">|</span>
                    <a href="mailto:support@your-domain.com" class="footer-link">Support</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        // Email Verification Handler
        const EmailVerification = {
            // Configuration
            config: {
                apiUrl: '/api',
                redirectDelay: 5000,
                maxRetries: 3
            },

            // State
            state: {
                token: null,
                retryCount: 0,
                countdownInterval: null
            },

            // DOM elements
            elements: {
                loadingOverlay: document.getElementById('loading-overlay'),
                successSection: document.getElementById('verification-success'),
                errorSection: document.getElementById('verification-error'),
                processingSection: document.getElementById('verification-processing'),
                errorDetails: document.getElementById('error-details'),
                connectBtn: document.getElementById('connect-now-btn'),
                resendBtn: document.getElementById('resend-btn'),
                countdown: document.getElementById('countdown')
            },

            /**
             * Initialize verification
             */
            init() {
                this.getTokenFromUrl();
                this.bindEvents();
                this.verifyEmail();
            },

            /**
             * Get verification token from URL
             */
            getTokenFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                this.state.token = urlParams.get('token');
                
                if (!this.state.token) {
                    this.showError('No verification token provided');
                    return;
                }
            },

            /**
             * Bind event listeners
             */
            bindEvents() {
                this.elements.connectBtn?.addEventListener('click', () => {
                    this.connectToWiFi();
                });

                this.elements.resendBtn?.addEventListener('click', () => {
                    this.resendVerification();
                });
            },

            /**
             * Verify email with API
             */
            async verifyEmail() {
                if (!this.state.token) {
                    return;
                }

                try {
                    const response = await this.apiRequest('GET', `/verify/${this.state.token}`);
                    
                    if (response.success) {
                        this.showSuccess();
                        this.startCountdown();
                    } else {
                        this.showError(response.message || 'Verification failed');
                    }
                } catch (error) {
                    console.error('Verification error:', error);
                    this.showError(error.message || 'Verification failed. Please try again.');
                } finally {
                    this.hideLoading();
                }
            },

            /**
             * Show success state
             */
            showSuccess() {
                this.hideAllSections();
                this.elements.successSection?.classList.remove('hidden');
            },

            /**
             * Show error state
             */
            showError(message) {
                this.hideAllSections();
                if (this.elements.errorDetails) {
                    this.elements.errorDetails.textContent = message;
                }
                this.elements.errorSection?.classList.remove('hidden');
            },

            /**
             * Hide all verification sections
             */
            hideAllSections() {
                this.elements.successSection?.classList.add('hidden');
                this.elements.errorSection?.classList.add('hidden');
                this.elements.processingSection?.classList.add('hidden');
            },

            /**
             * Hide loading overlay
             */
            hideLoading() {
                this.elements.loadingOverlay?.classList.add('hidden');
            },

            /**
             * Start countdown for automatic connection
             */
            startCountdown() {
                let seconds = 5;
                
                this.state.countdownInterval = setInterval(() => {
                    seconds--;
                    if (this.elements.countdown) {
                        this.elements.countdown.textContent = seconds;
                    }
                    
                    if (seconds <= 0) {
                        clearInterval(this.state.countdownInterval);
                        this.connectToWiFi();
                    }
                }, 1000);
            },

            /**
             * Connect to WiFi (redirect to success page)
             */
            connectToWiFi() {
                if (this.state.countdownInterval) {
                    clearInterval(this.state.countdownInterval);
                }
                
                // Redirect to success page or close captive portal
                window.location.href = 'success.html';
            },

            /**
             * Resend verification email
             */
            async resendVerification() {
                if (this.state.retryCount >= this.config.maxRetries) {
                    alert('Maximum retry attempts reached. Please register again.');
                    return;
                }

                const btn = this.elements.resendBtn;
                if (!btn) return;

                // Set loading state
                btn.disabled = true;
                btn.querySelector('.btn-text').classList.add('hidden');
                btn.querySelector('.btn-spinner').classList.remove('hidden');

                try {
                    // This would need to be implemented based on your API
                    // For now, show a success message
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate API call
                    
                    alert('Verification email sent! Please check your inbox.');
                    this.state.retryCount++;
                } catch (error) {
                    alert('Failed to resend verification email. Please try again.');
                } finally {
                    // Reset button state
                    btn.disabled = false;
                    btn.querySelector('.btn-text').classList.remove('hidden');
                    btn.querySelector('.btn-spinner').classList.add('hidden');
                }
            },

            /**
             * Make API request
             */
            async apiRequest(method, endpoint, data = null) {
                const url = this.config.apiUrl + endpoint;
                
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                };

                if (data && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
                    options.body = JSON.stringify(data);
                }

                try {
                    const response = await fetch(url, options);
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.message || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    return result;
                } catch (error) {
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        throw new Error('Network error. Please check your internet connection.');
                    }
                    throw error;
                }
            }
        };

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => EmailVerification.init());
        } else {
            EmailVerification.init();
        }
    </script>
</body>
</html> 